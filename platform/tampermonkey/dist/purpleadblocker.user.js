// ==UserScript==
// @name         Purple Adblocker
// @source       https://github.com/arthurbolsoni/Purple-adblock
// @version      2.6.3
// @description  Per aspera ad astra
// @author       ArthurBolzoni
// @downloadURL  https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @updateURL    https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

var O=`var y=Object.create;var{defineProperty:u,getPrototypeOf:i,getOwnPropertyNames:a}=Object;var r=Object.prototype.hasOwnProperty;var n=(O,J,z)=>{z=O!=null?y(i(O)):{};const W=J||!O||!O.__esModule?u(z,"default",{value:O,enumerable:!0}):z;for(let V of a(O))if(!r.call(W,V))u(W,V,{get:()=>O[V],enumerable:!0});return W};var t=(O,J)=>()=>(J||O((J={exports:{}}).exports,J),J.exports);var K=function(O,J,z,W){var V=arguments.length,Y=V<3?J:W===null?W=Object.getOwnPropertyDescriptor(J,z):W,\$;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")Y=Reflect.decorate(O,J,z,W);else for(var Z=O.length-1;Z>=0;Z--)if(\$=O[Z])Y=(V<3?\$(Y):V>3?\$(J,z,Y):\$(J,z))||Y;return V>3&&Y&&Object.defineProperty(J,z,Y),Y};var p=t((M0,o)=>{var C;if(typeof window!=="undefined")C=window;else if(typeof global!=="undefined")C=global;else if(typeof self!=="undefined")C=self;else C={};o.exports=C});var l=()=>{return(O)=>{}};var f=(O,J=null)=>{return(z,W)=>{if(!global.routerList)global.routerList=[];global.routerList.push({propertyKey:W,match:O,ignore:J})}},U=(O)=>{return(J,z)=>{global.addEventListener("message",(W)=>{if(W?.data?.funcName==O)global.appController[z](W.data)})}};var q;(function(Z){Z["PICTURE"]="picture-by-picture";Z["THUNDERDOME"]="thunderdome";Z["EMBED"]="embed";Z["FRONTPAGE"]="frontpage";Z["SITE"]="site";Z["EXTERNAL"]="external";Z["DNS"]="dns"})(q||(q={}));class A{O;getSettings=()=>global.postMessage({type:"getSettings"});constructor(O){this.appService=O;this.getSettings()}async setIntegrity(O){this.appService.setIntegrityToken(JSON.parse(O.value).token)}async onChannel(O,J){const z=await global.request(O,J);if(!z.ok)return console.log("Error on channel load"),z;const W=await z.text(),V=/hls\/(.*).m3u8/gm.exec(O)||[];return await this.appService.setChannel(V[1]),new Response(W)}async onFetch(O,J){const z=await(await request(O,J)).text(),W=await this.appService.onFetch(z);return new Response(W)}async onChannelPicture(O,J){const z=await global.request(O,J);if(!z.ok)return console.log("Error on channel load"),z;const W=await z.text();return await this.appService.currentStream().setStreamAccess(W,q.PICTURE),console.log("picture-by-picture",W),new Response}async setSettings(O){this.appService.setSettings(O)}async setQuality(O){this.appService.quality=O.value}}K([U("setIntegrity")],A.prototype,"setIntegrity",null),K([f("usher.ttvnw.net/api/channel/hls/","picture-by-picture")],A.prototype,"onChannel",null),K([f("hls.ttvnw.net/v1/playlist/")],A.prototype,"onFetch",null),K([f("picture-by-picture")],A.prototype,"onChannelPicture",null),K([U("setSettings")],A.prototype,"setSettings",null),K([U("setQuality")],A.prototype,"setQuality",null),A=K([l()],A);class b{O;constructor(O){this.integrityToken=O}async playbackAccessToken(O,J,z){const W={operationName:"PlaybackAccessToken",variables:{isLive:!0,login:O,isVod:!1,vodID:"",playerType:J},extensions:{persistedQuery:{version:1,sha256Hash:"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}},Y=await(await global.request("https://gql.twitch.tv/gql#origin=twilight",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko","Client-Integrity":z},body:JSON.stringify(W)})).json();return{token:Y.data.streamPlaybackAccessToken.value,signature:Y.data.streamPlaybackAccessToken.signature}}async playbackAccessToken_Template(O,J){const W={operationName:"PlaybackAccessToken_Template",query:'query PlaybackAccessToken_Template(\$login: String!, \$isLive: Boolean!, \$vodID: ID!, \$isVod: Boolean!, \$playerType: String!) { streamPlaybackAccessToken(channelName: \$login, params: {platform: "web", playerBackend: "mediaplayer", playerType: \$playerType}) @include(if: \$isLive) { value signature __typename } videoPlaybackAccessToken(id: \$vodID, params: {platform: "web", playerBackend: "mediaplayer", playerType: \$playerType}) @include(if: \$isVod) { value signature __typename }}',variables:{isLive:!0,isVod:!1,vodID:"",login:O,playerType:J}},Y=await(await global.request("https://gql.twitch.tv/gql",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:JSON.stringify(W)})).json();return{token:Y.data.streamPlaybackAccessToken.value,signature:Y.data.streamPlaybackAccessToken.signature}}async getM3U8(O,J){const z="allow_source=true&fast_bread=true&p="+Math.floor(Math.random()*1e7)+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+J.signature+"&supported_codecs=avc1&token="+J.token;return(await global.request("https://usher.ttvnw.net/api/channel/hls/"+O+".m3u8?"+z)).text()}}class x{type;urlList;sig;bestQuality=()=>{return this.urlList[0]};findByQuality=(O)=>this.urlList.find((J)=>J.quality==O);constructor(O){Object.assign(this,O)}}class L{serverList=[];channelName;twitchService;constructor(O){this.channelName=O,this.twitchService=new b("")}removeServer(O){const J=this.serverList.indexOf(O);if(J>-1)this.serverList.splice(J,1)}setStreamAccess(O,J="local",z=!0){const W=[];let V;const Y=/NAME="((?:\S+\s+\S+|\S+))",AUTO(?:^|\S+\s+)(?:^|\S+\s+)(https:\/\/video(\S+).m3u8)/g;while((V=Y.exec(O))!==null)W.push({quality:V[1],url:V[2]});const \$=new x({type:J,urlList:W,sig:z});this.serverList.push(\$)}async createStreamAccess(O,J){try{const z=await this.twitchService.playbackAccessToken(this.channelName,O,J);console.log("New Connection: ",O,z.token.includes('"hide_ads":true'));const W=await this.twitchService.getM3U8(this.channelName,z);this.setStreamAccess(W,O)}catch(z){logPrint(z)}}getStreamByStreamType(O){const J=this.serverList.filter((z)=>z.type==O);if(!J)return[];return J}}var S=function(){function O(){this.listeners={}}var J=O.prototype;return J.on=function z(W,V){if(!this.listeners[W])this.listeners[W]=[];this.listeners[W].push(V)},J.off=function z(W,V){if(!this.listeners[W])return!1;var Y=this.listeners[W].indexOf(V);return this.listeners[W]=this.listeners[W].slice(0),this.listeners[W].splice(Y,1),Y>-1},J.trigger=function z(W){var V=this.listeners[W];if(!V)return;if(arguments.length===2){var Y=V.length;for(var \$=0;\$<Y;++\$)V[\$].call(this,arguments[1])}else{var Z=Array.prototype.slice.call(arguments,1),F=V.length;for(var I=0;I<F;++I)V[I].apply(this,Z)}},J.dispose=function z(){this.listeners={}},J.pipe=function z(W){this.on("data",function(V){W.push(V)})},O}();function _(){return _=Object.assign?Object.assign.bind():function(O){for(var J=1;J<arguments.length;J++){var z=arguments[J];for(var W in z)if(Object.prototype.hasOwnProperty.call(z,W))O[W]=z[W]}return O},_.apply(this,arguments)}var T=n(p(),1),e=function O(J){return T.default.atob?T.default.atob(J):Buffer.from(J,"base64").toString("binary")};function w(O){var J=e(O),z=new Uint8Array(J.length);for(var W=0;W<J.length;W++)z[W]=J.charCodeAt(W);return z}/*! @name m3u8-parser @version 6.0.0 @license Apache-2.0 */class m extends S{constructor(){super();this.buffer=""}push(O){let J;this.buffer+=O,J=this.buffer.indexOf("\n");for(;J>-1;J=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,J)),this.buffer=this.buffer.substring(J+1)}}var z0=String.fromCharCode(9),k=function(O){const J=/([0-9.]*)?@?([0-9.]*)?/.exec(O||""),z={};if(J[1])z.length=parseInt(J[1],10);if(J[2])z.offset=parseInt(J[2],10);return z},J0=function(){return new RegExp("(?:^|,)("+'(?:[^=]*)=(?:"[^"]*"|[^,]*)'+")")},R=function(O){const J={};if(!O)return J;const z=O.split(J0());let W=z.length,V;while(W--){if(z[W]==="")continue;V=/([^=]*)=(.*)/.exec(z[W]).slice(1),V[0]=V[0].replace(/^\s+|\s+\$/g,""),V[1]=V[1].replace(/^\s+|\s+\$/g,""),V[1]=V[1].replace(/^['"](.*)['"]\$/g,"\$1"),J[V[0]]=V[1]}return J};class c extends S{constructor(){super();this.customParsers=[],this.tagMappers=[]}push(O){let J,z;if(O=O.trim(),O.length===0)return;if(O[0]!=="#"){this.trigger("data",{type:"uri",uri:O});return}this.tagMappers.reduce((V,Y)=>{const \$=Y(O);if(\$===O)return V;return V.concat([\$])},[O]).forEach((V)=>{for(let Y=0;Y<this.customParsers.length;Y++)if(this.customParsers[Y].call(this,V))return;if(V.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:V.slice(1)});return}if(V=V.replace("\r",""),J=/^#EXTM3U/.exec(V),J){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(J=/^#EXTINF:([0-9\.]*)?,?(.*)?\$/.exec(V),J){if(z={type:"tag",tagType:"inf"},J[1])z.duration=parseFloat(J[1]);if(J[2])z.title=J[2];this.trigger("data",z);return}if(J=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(V),J){if(z={type:"tag",tagType:"targetduration"},J[1])z.duration=parseInt(J[1],10);this.trigger("data",z);return}if(J=/^#EXT-X-VERSION:([0-9.]*)?/.exec(V),J){if(z={type:"tag",tagType:"version"},J[1])z.version=parseInt(J[1],10);this.trigger("data",z);return}if(J=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(V),J){if(z={type:"tag",tagType:"media-sequence"},J[1])z.number=parseInt(J[1],10);this.trigger("data",z);return}if(J=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(V),J){if(z={type:"tag",tagType:"discontinuity-sequence"},J[1])z.number=parseInt(J[1],10);this.trigger("data",z);return}if(J=/^#EXT-X-PLAYLIST-TYPE:(.*)?\$/.exec(V),J){if(z={type:"tag",tagType:"playlist-type"},J[1])z.playlistType=J[1];this.trigger("data",z);return}if(J=/^#EXT-X-BYTERANGE:(.*)?\$/.exec(V),J){z=_(k(J[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",z);return}if(J=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(V),J){if(z={type:"tag",tagType:"allow-cache"},J[1])z.allowed=!/NO/.test(J[1]);this.trigger("data",z);return}if(J=/^#EXT-X-MAP:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"map"},J[1]){const Y=R(J[1]);if(Y.URI)z.uri=Y.URI;if(Y.BYTERANGE)z.byterange=k(Y.BYTERANGE)}this.trigger("data",z);return}if(J=/^#EXT-X-STREAM-INF:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"stream-inf"},J[1]){if(z.attributes=R(J[1]),z.attributes.RESOLUTION){const Y=z.attributes.RESOLUTION.split("x"),\$={};if(Y[0])\$.width=parseInt(Y[0],10);if(Y[1])\$.height=parseInt(Y[1],10);z.attributes.RESOLUTION=\$}if(z.attributes.BANDWIDTH)z.attributes.BANDWIDTH=parseInt(z.attributes.BANDWIDTH,10);if(z.attributes["FRAME-RATE"])z.attributes["FRAME-RATE"]=parseFloat(z.attributes["FRAME-RATE"]);if(z.attributes["PROGRAM-ID"])z.attributes["PROGRAM-ID"]=parseInt(z.attributes["PROGRAM-ID"],10)}this.trigger("data",z);return}if(J=/^#EXT-X-MEDIA:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"media"},J[1])z.attributes=R(J[1]);this.trigger("data",z);return}if(J=/^#EXT-X-ENDLIST/.exec(V),J){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(J=/^#EXT-X-DISCONTINUITY/.exec(V),J){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(J=/^#EXT-X-PROGRAM-DATE-TIME:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"program-date-time"},J[1])z.dateTimeString=J[1],z.dateTimeObject=new Date(J[1]);this.trigger("data",z);return}if(J=/^#EXT-X-KEY:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"key"},J[1]){if(z.attributes=R(J[1]),z.attributes.IV){if(z.attributes.IV.substring(0,2).toLowerCase()==="0x")z.attributes.IV=z.attributes.IV.substring(2);z.attributes.IV=z.attributes.IV.match(/.{8}/g),z.attributes.IV[0]=parseInt(z.attributes.IV[0],16),z.attributes.IV[1]=parseInt(z.attributes.IV[1],16),z.attributes.IV[2]=parseInt(z.attributes.IV[2],16),z.attributes.IV[3]=parseInt(z.attributes.IV[3],16),z.attributes.IV=new Uint32Array(z.attributes.IV)}}this.trigger("data",z);return}if(J=/^#EXT-X-START:(.*)\$/.exec(V),J){if(z={type:"tag",tagType:"start"},J[1])z.attributes=R(J[1]),z.attributes["TIME-OFFSET"]=parseFloat(z.attributes["TIME-OFFSET"]),z.attributes.PRECISE=/YES/.test(z.attributes.PRECISE);this.trigger("data",z);return}if(J=/^#EXT-X-CUE-OUT-CONT:(.*)?\$/.exec(V),J){if(z={type:"tag",tagType:"cue-out-cont"},J[1])z.data=J[1];else z.data="";this.trigger("data",z);return}if(J=/^#EXT-X-CUE-OUT:(.*)?\$/.exec(V),J){if(z={type:"tag",tagType:"cue-out"},J[1])z.data=J[1];else z.data="";this.trigger("data",z);return}if(J=/^#EXT-X-CUE-IN:(.*)?\$/.exec(V),J){if(z={type:"tag",tagType:"cue-in"},J[1])z.data=J[1];else z.data="";this.trigger("data",z);return}if(J=/^#EXT-X-SKIP:(.*)\$/.exec(V),J&&J[1]){if(z={type:"tag",tagType:"skip"},z.attributes=R(J[1]),z.attributes.hasOwnProperty("SKIPPED-SEGMENTS"))z.attributes["SKIPPED-SEGMENTS"]=parseInt(z.attributes["SKIPPED-SEGMENTS"],10);if(z.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES"))z.attributes["RECENTLY-REMOVED-DATERANGES"]=z.attributes["RECENTLY-REMOVED-DATERANGES"].split(z0);this.trigger("data",z);return}if(J=/^#EXT-X-PART:(.*)\$/.exec(V),J&&J[1]){if(z={type:"tag",tagType:"part"},z.attributes=R(J[1]),["DURATION"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=parseFloat(z.attributes[Y])}),["INDEPENDENT","GAP"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=/YES/.test(z.attributes[Y])}),z.attributes.hasOwnProperty("BYTERANGE"))z.attributes.byterange=k(z.attributes.BYTERANGE);this.trigger("data",z);return}if(J=/^#EXT-X-SERVER-CONTROL:(.*)\$/.exec(V),J&&J[1]){z={type:"tag",tagType:"server-control"},z.attributes=R(J[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=parseFloat(z.attributes[Y])}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=/YES/.test(z.attributes[Y])}),this.trigger("data",z);return}if(J=/^#EXT-X-PART-INF:(.*)\$/.exec(V),J&&J[1]){z={type:"tag",tagType:"part-inf"},z.attributes=R(J[1]),["PART-TARGET"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=parseFloat(z.attributes[Y])}),this.trigger("data",z);return}if(J=/^#EXT-X-PRELOAD-HINT:(.*)\$/.exec(V),J&&J[1]){z={type:"tag",tagType:"preload-hint"},z.attributes=R(J[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y)){z.attributes[Y]=parseInt(z.attributes[Y],10);const \$=Y==="BYTERANGE-LENGTH"?"length":"offset";z.attributes.byterange=z.attributes.byterange||{},z.attributes.byterange[\$]=z.attributes[Y],delete z.attributes[Y]}}),this.trigger("data",z);return}if(J=/^#EXT-X-RENDITION-REPORT:(.*)\$/.exec(V),J&&J[1]){z={type:"tag",tagType:"rendition-report"},z.attributes=R(J[1]),["LAST-MSN","LAST-PART"].forEach(function(Y){if(z.attributes.hasOwnProperty(Y))z.attributes[Y]=parseInt(z.attributes[Y],10)}),this.trigger("data",z);return}this.trigger("data",{type:"tag",data:V.slice(4)})})}addParser({expression:O,customType:J,dataParser:z,segment:W}){if(typeof z!=="function")z=(V)=>V;this.customParsers.push((V)=>{if(O.exec(V))return this.trigger("data",{type:"custom",data:z(V),customType:J,segment:W}),!0})}addTagMapper({expression:O,map:J}){const z=(W)=>{if(O.test(W))return J(W);return W};this.tagMappers.push(z)}}var O0=(O)=>O.toLowerCase().replace(/-(\w)/g,(J)=>J[1].toUpperCase()),N=function(O){const J={};return Object.keys(O).forEach(function(z){J[O0(z)]=O[z]}),J},g=function(O){const{serverControl:J,targetDuration:z,partTargetDuration:W}=O;if(!J)return;const V="#EXT-X-SERVER-CONTROL",Y="holdBack",\$="partHoldBack",Z=z&&z*3,F=W&&W*2;if(z&&!J.hasOwnProperty(Y))J[Y]=Z,this.trigger("info",{message:\`\${V} defaulting HOLD-BACK to targetDuration * 3 (\${Z}).\`});if(Z&&J[Y]<Z)this.trigger("warn",{message:\`\${V} clamping HOLD-BACK (\${J[Y]}) to targetDuration * 3 (\${Z})\`}),J[Y]=Z;if(W&&!J.hasOwnProperty(\$))J[\$]=W*3,this.trigger("info",{message:\`\${V} defaulting PART-HOLD-BACK to partTargetDuration * 3 (\${J[\$]}).\`});if(W&&J[\$]<F)this.trigger("warn",{message:\`\${V} clamping PART-HOLD-BACK (\${J[\$]}) to partTargetDuration * 2 (\${F}).\`}),J[\$]=F};class d extends S{constructor(){super();this.lineStream=new m,this.parseStream=new c,this.lineStream.pipe(this.parseStream);const O=this,J=[];let z={},W,V,Y=!1;const \$=function(){},Z={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},F="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";let I=0;this.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};let E=0,G=0;this.on("end",()=>{if(z.uri||!z.parts&&!z.preloadHints)return;if(!z.map&&W)z.map=W;if(!z.key&&V)z.key=V;if(!z.timeline&&typeof I==="number")z.timeline=I;this.manifest.preloadSegment=z}),this.parseStream.on("data",function(Q){let D,H;({tag(){({version(){if(Q.version)this.manifest.version=Q.version},"allow-cache"(){if(this.manifest.allowCache=Q.allowed,!("allowed"in Q))this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0},byterange(){const j={};if("length"in Q){if(z.byterange=j,j.length=Q.length,!("offset"in Q))Q.offset=E}if("offset"in Q)z.byterange=j,j.offset=Q.offset;E=j.offset+j.length},endlist(){this.manifest.endList=!0},inf(){if(!("mediaSequence"in this.manifest))this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"});if(!("discontinuitySequence"in this.manifest))this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"});if(Q.duration>0)z.duration=Q.duration;if(Q.duration===0)z.duration=0.01,this.trigger("info",{message:"updating zero segment duration to a small value"});this.manifest.segments=J},key(){if(!Q.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(Q.attributes.METHOD==="NONE"){V=null;return}if(!Q.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(Q.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:Q.attributes};return}if(Q.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:Q.attributes.URI};return}if(Q.attributes.KEYFORMAT===F){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(Q.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(Q.attributes.METHOD==="SAMPLE-AES-CENC")this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"});if(Q.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(Q.attributes.KEYID&&Q.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:Q.attributes.KEYFORMAT,keyId:Q.attributes.KEYID.substring(2)},pssh:w(Q.attributes.URI.split(",")[1])};return}if(!Q.attributes.METHOD)this.trigger("warn",{message:"defaulting key method to AES-128"});if(V={method:Q.attributes.METHOD||"AES-128",uri:Q.attributes.URI},typeof Q.attributes.IV!=="undefined")V.iv=Q.attributes.IV},"media-sequence"(){if(!isFinite(Q.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+Q.number});return}this.manifest.mediaSequence=Q.number},"discontinuity-sequence"(){if(!isFinite(Q.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+Q.number});return}this.manifest.discontinuitySequence=Q.number,I=Q.number},"playlist-type"(){if(!/VOD|EVENT/.test(Q.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+Q.playlist});return}this.manifest.playlistType=Q.playlistType},map(){if(W={},Q.uri)W.uri=Q.uri;if(Q.byterange)W.byterange=Q.byterange;if(V)W.key=V},"stream-inf"(){if(this.manifest.playlists=J,this.manifest.mediaGroups=this.manifest.mediaGroups||Z,!Q.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}if(!z.attributes)z.attributes={};_(z.attributes,Q.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||Z,!(Q.attributes&&Q.attributes.TYPE&&Q.attributes["GROUP-ID"]&&Q.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}const j=this.manifest.mediaGroups[Q.attributes.TYPE];if(j[Q.attributes["GROUP-ID"]]=j[Q.attributes["GROUP-ID"]]||{},D=j[Q.attributes["GROUP-ID"]],H={default:/yes/i.test(Q.attributes.DEFAULT)},H.default)H.autoselect=!0;else H.autoselect=/yes/i.test(Q.attributes.AUTOSELECT);if(Q.attributes.LANGUAGE)H.language=Q.attributes.LANGUAGE;if(Q.attributes.URI)H.uri=Q.attributes.URI;if(Q.attributes["INSTREAM-ID"])H.instreamId=Q.attributes["INSTREAM-ID"];if(Q.attributes.CHARACTERISTICS)H.characteristics=Q.attributes.CHARACTERISTICS;if(Q.attributes.FORCED)H.forced=/yes/i.test(Q.attributes.FORCED);D[Q.attributes.NAME]=H},discontinuity(){I+=1,z.discontinuity=!0,this.manifest.discontinuityStarts.push(J.length)},"program-date-time"(){if(typeof this.manifest.dateTimeString==="undefined")this.manifest.dateTimeString=Q.dateTimeString,this.manifest.dateTimeObject=Q.dateTimeObject;z.dateTimeString=Q.dateTimeString,z.dateTimeObject=Q.dateTimeObject},targetduration(){if(!isFinite(Q.duration)||Q.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+Q.duration});return}this.manifest.targetDuration=Q.duration,g.call(this,this.manifest)},start(){if(!Q.attributes||isNaN(Q.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:Q.attributes["TIME-OFFSET"],precise:Q.attributes.PRECISE}},"cue-out"(){z.cueOut=Q.data},"cue-out-cont"(){z.cueOutCont=Q.data},"cue-in"(){z.cueIn=Q.data},skip(){this.manifest.skip=N(Q.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",Q.attributes,["SKIPPED-SEGMENTS"])},part(){Y=!0;const j=this.manifest.segments.length,X=N(Q.attributes);if(z.parts=z.parts||[],z.parts.push(X),X.byterange){if(!X.byterange.hasOwnProperty("offset"))X.byterange.offset=G;G=X.byterange.offset+X.byterange.length}const B=z.parts.length-1;if(this.warnOnMissingAttributes_(\`#EXT-X-PART #\${B} for segment #\${j}\`,Q.attributes,["URI","DURATION"]),this.manifest.renditionReports)this.manifest.renditionReports.forEach((P,M)=>{if(!P.hasOwnProperty("lastPart"))this.trigger("warn",{message:\`#EXT-X-RENDITION-REPORT #\${M} lacks required attribute(s): LAST-PART\`})})},"server-control"(){const j=this.manifest.serverControl=N(Q.attributes);if(!j.hasOwnProperty("canBlockReload"))j.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"});if(g.call(this,this.manifest),j.canSkipDateranges&&!j.hasOwnProperty("canSkipUntil"))this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const j=this.manifest.segments.length,X=N(Q.attributes),B=X.type&&X.type==="PART";if(z.preloadHints=z.preloadHints||[],z.preloadHints.push(X),X.byterange){if(!X.byterange.hasOwnProperty("offset")){if(X.byterange.offset=B?G:0,B)G=X.byterange.offset+X.byterange.length}}const P=z.preloadHints.length-1;if(this.warnOnMissingAttributes_(\`#EXT-X-PRELOAD-HINT #\${P} for segment #\${j}\`,Q.attributes,["TYPE","URI"]),!X.type)return;for(let M=0;M<z.preloadHints.length-1;M++){const h=z.preloadHints[M];if(!h.type)continue;if(h.type===X.type)this.trigger("warn",{message:\`#EXT-X-PRELOAD-HINT #\${P} for segment #\${j} has the same TYPE \${X.type} as preload hint #\${M}\`})}},"rendition-report"(){const j=N(Q.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(j);const X=this.manifest.renditionReports.length-1,B=["LAST-MSN","URI"];if(Y)B.push("LAST-PART");this.warnOnMissingAttributes_(\`#EXT-X-RENDITION-REPORT #\${X}\`,Q.attributes,B)},"part-inf"(){if(this.manifest.partInf=N(Q.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",Q.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget)this.manifest.partTargetDuration=this.manifest.partInf.partTarget;g.call(this,this.manifest)}}[Q.tagType]||\$).call(O)},uri(){if(z.uri=Q.uri,J.push(z),this.manifest.targetDuration&&!("duration"in z))this.trigger("warn",{message:"defaulting segment duration to the target duration"}),z.duration=this.manifest.targetDuration;if(V)z.key=V;if(z.timeline=I,W)z.map=W;G=0,z={}},comment(){},custom(){if(Q.segment)z.custom=z.custom||{},z.custom[Q.customType]=Q.data;else this.manifest.custom=this.manifest.custom||{},this.manifest.custom[Q.customType]=Q.data}})[Q.type].call(O)})}warnOnMissingAttributes_(O,J,z){const W=[];if(z.forEach(function(V){if(!J.hasOwnProperty(V))W.push(V)}),W.length)this.trigger("warn",{message:\`\${O} lacks required attribute(s): \${W.join(", ")}\`})}push(O){this.lineStream.push(O)}end(){this.lineStream.push("\n"),this.trigger("end")}addParser(O){this.parseStream.addParser(O)}addTagMapper(O){this.parseStream.addTagMapper(O)}}class v{integrityToken="";streamList=[];actualChannel="";playingAds=!1;setting;quality="";getQuality=()=>global.postMessage({type:"getQuality"});getSettings=()=>global.postMessage({type:"getSettings"});pause=()=>global.postMessage({type:"pause"});play=()=>global.postMessage({type:"play"});setSettings=(O)=>{this.setting=O,logPrint("Settings loaded")};setIntegrityToken=(O)=>this.integrityToken=O;pauseAndPlay=async()=>{this.pause(),await new Promise((O)=>setTimeout(O,500)),this.play()};onStartAds=()=>{console.log("ads started"),this.pauseAndPlay(),this.pauseAndPlay()};onEndAds=()=>{console.log("ads ended"),this.pauseAndPlay(),this.pauseAndPlay()};isAds=(O,J=!1)=>{const z=this.hasAds(O);if(!J)return z;if(this.playingAds==!1&&this.playingAds!=z)this.onStartAds();if(this.playingAds==!0&&this.playingAds!=z)this.onEndAds();return this.playingAds=z,this.playingAds};hasAds=(O)=>O?.toString().includes("stitched")||O?.toString().includes("Amazon")||O?.toString().includes("DCM,");currentStream=(O=this.actualChannel)=>{return this.streamList?.find((J)=>J.channelName===O)};isWhitelist(){return this.setting?.whitelist?.includes(this.actualChannel)||!1}async onFetch(O){if(this.isWhitelist())return O;if(!this.isAds(O,!0))return this.mergeM3u8Contents([O]);let J=[];const z=await this.fetchm3u8ByStreamType(q.FRONTPAGE);if(!z.data)this.currentStream().createStreamAccess(q.FRONTPAGE,this.integrityToken);if(z.data)J.push(...z.dump);const W=await this.fetchm3u8ByStreamType(q.PICTURE);if(!W.data)this.currentStream().createStreamAccess(q.PICTURE,this.integrityToken);if(W.data)return Promise.resolve(W.dump?.[0]??"");return J.length!=0?this.mergeM3u8Contents([O,...J]):O}generateM3u8(O){let J="#EXTM3U\n";if(O.targetDuration)J+=\`#EXT-X-TARGETDURATION:\${O.targetDuration}\n\`;if(O.mediaSequence)J+=\`#EXT-X-MEDIA-SEQUENCE:\${O.mediaSequence}\n\`;if(O.segments)O.segments.forEach((z)=>{if(z.duration)J+=\`#EXTINF:\${z.duration}\`,J+="\n";J+=\`\${z.uri}\n\`});return J}mergeM3u8Contents(O){const J=O.map((Y)=>{const \$=new d;\$.push(Y),\$.end();const Z=\$.manifest;if(Z.segments)Z.segments.forEach((F)=>{const I=new RegExp(\`#EXTINF:([0-9.]*)?,?(.*)(?:\n|\r\n)\${F.uri}\`),E=Y.match(I);if(E)F.title=E[2]?E[2].trim():""});return Z}),z=J[0],W=J.slice(1);if(z.segments){console.log("Segmentos encontrados no manifesto principal:",z.segments.length),console.log("Manifestos de suporte encontrados:",W.length);let Y=0,\$=0;for(let Z=0;Z<z.segments.length;Z++){const F=z.segments[Z];let I=!1;if(this.hasAds(F.title)){if(W.forEach((E)=>{const G=E?.segments?.find((Q)=>{if(this.hasAds(Q.title))return!1;const D=new Date(F.dateTimeString),H=new Date(Q.dateTimeString);return D.setMilliseconds(0),H.setMilliseconds(0),D.getTime()===H.getTime()});if(G)z.segments[Z]=G,I=!0}),!I)z.segments.splice(Z,1),Z--,Y++;if(I)\$++}}console.log("Segmento com ads removidos:",Y),console.log("Segmento com ads substitu\xEDdos:",\$)}return this.generateM3u8(z)}async fetchm3u8ByStreamType(O){logPrint("Stream Type: "+O);let J=[],z=this.currentStream().getStreamByStreamType(O);for(let W of z){const V=W.findByQuality(this.quality)||W.bestQuality(),Y=await(await global.request(V?.url)).text();if(J.push(Y),this.isAds(Y)){logPrint("Stream Type: "+O+" - Ads found"),this.currentStream().removeServer(W);continue}return{data:Y,dump:J}}return{data:null,dump:J}}setChannel(O){logPrint("Loading channel",O),this.actualChannel=O;let J=this.streamList.find((z)=>z.channelName===O);if(!J)J=new L(O),this.streamList.push(J)}}function s(){global.logPrint=(O)=>console.log("[Purple]: ",O),global.appController=new A(new v),global.logPrint("Script running")}global.request=global.fetch;global.fetch=async(O,J)=>{if(typeof O==="string"){for(var z=0,W=routerList.length;z<W;z++)if(O.includes(routerList[z].match)&&!O.includes(routerList[z].ignore))return global.appController[routerList[z].propertyKey](O,J)}return global.request.apply(null,[O,J])};s();export{s as default};
`;(function(){let i;window.Worker=class u extends Worker{constructor(t,g){if(console.log("new worker intance "+t),t.toString()=="")super(t,g);console.log("[Purple]: init "+t.toString());const s=new XMLHttpRequest;s.open("GET",t.toString(),!1),s.send();const a=s.responseText,c=`${O}
      ${a}`,f=URL.createObjectURL(new Blob([c],{type:"text/javascript"}));super(f);i=this,i.declareEventWorker(),i.declareEventWindow(),i.integrity()}async integrity(){global.request=fetch,global.fetch=async(t,g)=>{const s=await global.request(t,g),a=await s.text();if(t=="https://gql.twitch.tv/integrity")i.postMessage({funcName:"setIntegrity",value:a});return new Response(a,s)}}declareEventWorker(){this.addEventListener("message",(t)=>{switch(t?.data?.type){case"getSettings":{window.postMessage({type:"getSettings",value:null});break}case"PlayerQualityChanged":{i.postMessage({funcName:"setQuality",value:t.data.arg.name});break}case"pause":{i.postMessage({funcName:"pause",args:void 0,id:1});break}case"play":{i.postMessage({funcName:"play",args:void 0,id:1});break}default:break}switch(t?.data?.arg?.key){case"quality":{if(!t.data.arg.value.name)break;console.log("Changed quality by player: "+t.data.arg.value.name),i.postMessage({funcName:"setQuality",value:t.data.arg.value.name});break}case"state":i.postMessage({funcName:t.data.arg.value});default:break}switch(t?.data?.arg?.name){case"pause":break;case"play":break;default:break}})}declareEventWindow(){window.addEventListener("message",(t)=>{switch(t.data.type){case"setSettings":i.postMessage({funcName:"setSettings",value:t.data.value})}})}}})();
