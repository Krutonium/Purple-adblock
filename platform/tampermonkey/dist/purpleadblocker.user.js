// ==UserScript==
// @name         Purple Adblocker
// @source       https://github.com/arthurbolsoni/Purple-adblock
// @version      2.6.3
// @description  Per aspera ad astra
// @author       ArthurBolzoni
// @downloadURL  https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @updateURL    https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/platform/tampermonkey/dist/purpleadblocker.user.js
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

const o='var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);const s=(t,e=null)=>(s,i)=>{self.routerList||(self.routerList=[]),self.routerList.push({propertyKey:i,match:t,ignore:e})},i=t=>(e,s)=>{self.addEventListener("message",(e=>{var i;(null==(i=null==e?void 0:e.data)?void 0:i.funcName)==t&&self.appController[s](e.data)}))};var a=(t=>(t.PICTURE="picture-by-picture",t.THUNDERDOME="thunderdome",t.EMBED="embed",t.FRONTPAGE="frontpage",t.SITE="site",t.EXTERNAL="external",t.DNS="dns",t))(a||{}),r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,o=(t,e,s,i)=>{for(var a,o=i>1?void 0:i?n(e,s):e,u=t.length-1;u>=0;u--)(a=t[u])&&(o=(i?a(e,s,o):a(o))||o);return i&&o&&r(e,s,o),o};let u=class{constructor(t){e(this,"getSettings",(()=>self.postMessage({type:"getSettings"}))),this.appService=t,this.getSettings()}async setIntegrity(t){this.appService.setIntegrityToken(JSON.parse(t.value).token)}async onChannel(t,e){const s=await self.request(t,e);if(!s.ok)return console.log("Error on channel load"),s;const i=await s.text(),a=/hls\\/(.*).m3u8/gm.exec(t)||[];return await this.appService.setChannel(a[1]),new Response(i)}async onFetch(t,e){const s=await(await request(t,e)).text(),i=await this.appService.onFetch(s);return new Response(i)}async onChannelPicture(t,e){const s=await self.request(t,e);if(!s.ok)return console.log("Error on channel load"),s;const i=await s.text();return await this.appService.currentStream().setStreamAccess(i,a.PICTURE),console.log("picture-by-picture",i),new Response}async setSettings(t){this.appService.setSettings(t)}async setQuality(t){this.appService.quality=t.value}};o([i("setIntegrity")],u.prototype,"setIntegrity",1),o([s("usher.ttvnw.net/api/channel/hls/","picture-by-picture")],u.prototype,"onChannel",1),o([s("hls.ttvnw.net/v1/playlist/")],u.prototype,"onFetch",1),o([s("picture-by-picture")],u.prototype,"onChannelPicture",1),o([i("setSettings")],u.prototype,"setSettings",1),o([i("setQuality")],u.prototype,"setQuality",1),u=o([t=>{}],u);class g{constructor(t){this.integrityToken=t}async playbackAccessToken(t,e,s){const i={operationName:"PlaybackAccessToken",variables:{isLive:!0,login:t,isVod:!1,vodID:"",playerType:e},extensions:{persistedQuery:{version:1,sha256Hash:"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}},a=await self.request("https://gql.twitch.tv/gql#origin=twilight",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko","Client-Integrity":s},body:JSON.stringify(i)}),r=await a.json();return{token:r.data.streamPlaybackAccessToken.value,signature:r.data.streamPlaybackAccessToken.signature}}async playbackAccessToken_Template(t,e){const s={operationName:"PlaybackAccessToken_Template",query:\'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) { streamPlaybackAccessToken(channelName: $login, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) { value signature __typename } videoPlaybackAccessToken(id: $vodID, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) { value signature __typename }}\',variables:{isLive:!0,isVod:!1,vodID:"",login:t,playerType:e}},i=await self.request("https://gql.twitch.tv/gql",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:JSON.stringify(s)}),a=await i.json();return{token:a.data.streamPlaybackAccessToken.value,signature:a.data.streamPlaybackAccessToken.signature}}async getM3U8(t,e){const s="allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+e.signature+"&supported_codecs=avc1&token="+e.token;return(await self.request("https://usher.ttvnw.net/api/channel/hls/"+t+".m3u8?"+s)).text()}}class l{constructor(t){e(this,"type"),e(this,"urlList"),e(this,"sig"),e(this,"bestQuality",(()=>this.urlList[0])),e(this,"findByQuality",(t=>this.urlList.find((e=>e.quality==t)))),Object.assign(this,t)}}let c=class{constructor(t){e(this,"serverList",[]),e(this,"channelName"),e(this,"twitchService"),this.channelName=t,this.twitchService=new g("")}removeServer(t){const e=this.serverList.indexOf(t);e>-1&&this.serverList.splice(e,1)}setStreamAccess(t,e="local",s=!0){const i=[];let a;const r=/NAME="((?:\\S+\\s+\\S+|\\S+))",AUTO(?:^|\\S+\\s+)(?:^|\\S+\\s+)(https:\\/\\/video(\\S+).m3u8)/g;for(;null!==(a=r.exec(t));)i.push({quality:a[1],url:a[2]});const n=new l({type:e,urlList:i,sig:s});this.serverList.push(n)}async createStreamAccess(t,e){try{const s=await this.twitchService.playbackAccessToken(this.channelName,t,e);console.log("New Connection: ",t,s.token.includes(\'"hide_ads":true\'));const i=await this.twitchService.getM3U8(this.channelName,s);this.setStreamAccess(i,t)}catch(s){logPrint(s)}}getStreamByStreamType(t){const e=this.serverList.filter((e=>e.type==t));return e||[]}};var h=function(){function t(){this.listeners={}}var e=t.prototype;return e.on=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},e.off=function(t,e){if(!this.listeners[t])return!1;var s=this.listeners[t].indexOf(e);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(s,1),s>-1},e.trigger=function(t){var e=this.listeners[t];if(e)if(2===arguments.length)for(var s=e.length,i=0;i<s;++i)e[i].call(this,arguments[1]);else for(var a=Array.prototype.slice.call(arguments,1),r=e.length,n=0;n<r;++n)e[n].apply(this,a)},e.dispose=function(){this.listeners={}},e.pipe=function(t){this.on("data",(function(e){t.push(e)}))},t}();function p(){return p=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},p.apply(this,arguments)}function d(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}const m=d("undefined"!=typeof window?window:"undefined"!=typeof self||"undefined"!=typeof self?self:{});function f(t){for(var e,s=(e=t,m.atob?m.atob(e):Buffer.from(e,"base64").toString("binary")),i=new Uint8Array(s.length),a=0;a<s.length;a++)i[a]=s.charCodeAt(a);return i}\n/*! @name m3u8-parser @version 7.1.0 @license Apache-2.0 */class T extends h{constructor(){super(),this.buffer=""}push(t){let e;for(this.buffer+=t,e=this.buffer.indexOf("\\n");e>-1;e=this.buffer.indexOf("\\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}}const E=String.fromCharCode(9),y=function(t){const e=/([0-9.]*)?@?([0-9.]*)?/.exec(t||""),s={};return e[1]&&(s.length=parseInt(e[1],10)),e[2]&&(s.offset=parseInt(e[2],10)),s},b=function(t){const e={};if(!t)return e;const s=t.split(new RegExp(\'(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))\'));let i,a=s.length;for(;a--;)""!==s[a]&&(i=/([^=]*)=(.*)/.exec(s[a]).slice(1),i[0]=i[0].replace(/^\\s+|\\s+$/g,""),i[1]=i[1].replace(/^\\s+|\\s+$/g,""),i[1]=i[1].replace(/^[\'"](.*)[\'"]$/g,"$1"),e[i[0]]=i[1]);return e};class A extends h{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(t){let e,s;if(0===(t=t.trim()).length)return;if("#"!==t[0])return void this.trigger("data",{type:"uri",uri:t});this.tagMappers.reduce(((e,s)=>{const i=s(t);return i===t?e:e.concat([i])}),[t]).forEach((t=>{for(let e=0;e<this.customParsers.length;e++)if(this.customParsers[e].call(this,t))return;if(0===t.indexOf("#EXT"))if(t=t.replace("\\r",""),e=/^#EXTM3U/.exec(t),e)this.trigger("data",{type:"tag",tagType:"m3u"});else{if(e=/^#EXTINF:([0-9\\.]*)?,?(.*)?$/.exec(t),e)return s={type:"tag",tagType:"inf"},e[1]&&(s.duration=parseFloat(e[1])),e[2]&&(s.title=e[2]),void this.trigger("data",s);if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(t),e)return s={type:"tag",tagType:"targetduration"},e[1]&&(s.duration=parseInt(e[1],10)),void this.trigger("data",s);if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(t),e)return s={type:"tag",tagType:"version"},e[1]&&(s.version=parseInt(e[1],10)),void this.trigger("data",s);if(e=/^#EXT-X-MEDIA-SEQUENCE:(\\-?[0-9.]*)?/.exec(t),e)return s={type:"tag",tagType:"media-sequence"},e[1]&&(s.number=parseInt(e[1],10)),void this.trigger("data",s);if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\\-?[0-9.]*)?/.exec(t),e)return s={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(s.number=parseInt(e[1],10)),void this.trigger("data",s);if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(t),e)return s={type:"tag",tagType:"playlist-type"},e[1]&&(s.playlistType=e[1]),void this.trigger("data",s);if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(t),e)return s=p(y(e[1]),{type:"tag",tagType:"byterange"}),void this.trigger("data",s);if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(t),e)return s={type:"tag",tagType:"allow-cache"},e[1]&&(s.allowed=!/NO/.test(e[1])),void this.trigger("data",s);if(e=/^#EXT-X-MAP:(.*)$/.exec(t),e){if(s={type:"tag",tagType:"map"},e[1]){const t=b(e[1]);t.URI&&(s.uri=t.URI),t.BYTERANGE&&(s.byterange=y(t.BYTERANGE))}this.trigger("data",s)}else if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(t),e){if(s={type:"tag",tagType:"stream-inf"},e[1]){if(s.attributes=b(e[1]),s.attributes.RESOLUTION){const t=s.attributes.RESOLUTION.split("x"),e={};t[0]&&(e.width=parseInt(t[0],10)),t[1]&&(e.height=parseInt(t[1],10)),s.attributes.RESOLUTION=e}s.attributes.BANDWIDTH&&(s.attributes.BANDWIDTH=parseInt(s.attributes.BANDWIDTH,10)),s.attributes["FRAME-RATE"]&&(s.attributes["FRAME-RATE"]=parseFloat(s.attributes["FRAME-RATE"])),s.attributes["PROGRAM-ID"]&&(s.attributes["PROGRAM-ID"]=parseInt(s.attributes["PROGRAM-ID"],10))}this.trigger("data",s)}else{if(e=/^#EXT-X-MEDIA:(.*)$/.exec(t),e)return s={type:"tag",tagType:"media"},e[1]&&(s.attributes=b(e[1])),void this.trigger("data",s);if(e=/^#EXT-X-ENDLIST/.exec(t),e)this.trigger("data",{type:"tag",tagType:"endlist"});else if(e=/^#EXT-X-DISCONTINUITY/.exec(t),e)this.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(t),e)return s={type:"tag",tagType:"program-date-time"},e[1]&&(s.dateTimeString=e[1],s.dateTimeObject=new Date(e[1])),void this.trigger("data",s);if(e=/^#EXT-X-KEY:(.*)$/.exec(t),e)return s={type:"tag",tagType:"key"},e[1]&&(s.attributes=b(e[1]),s.attributes.IV&&("0x"===s.attributes.IV.substring(0,2).toLowerCase()&&(s.attributes.IV=s.attributes.IV.substring(2)),s.attributes.IV=s.attributes.IV.match(/.{8}/g),s.attributes.IV[0]=parseInt(s.attributes.IV[0],16),s.attributes.IV[1]=parseInt(s.attributes.IV[1],16),s.attributes.IV[2]=parseInt(s.attributes.IV[2],16),s.attributes.IV[3]=parseInt(s.attributes.IV[3],16),s.attributes.IV=new Uint32Array(s.attributes.IV))),void this.trigger("data",s);if(e=/^#EXT-X-START:(.*)$/.exec(t),e)return s={type:"tag",tagType:"start"},e[1]&&(s.attributes=b(e[1]),s.attributes["TIME-OFFSET"]=parseFloat(s.attributes["TIME-OFFSET"]),s.attributes.PRECISE=/YES/.test(s.attributes.PRECISE)),void this.trigger("data",s);if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(t),e)return s={type:"tag",tagType:"cue-out-cont"},e[1]?s.data=e[1]:s.data="",void this.trigger("data",s);if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(t),e)return s={type:"tag",tagType:"cue-out"},e[1]?s.data=e[1]:s.data="",void this.trigger("data",s);if(e=/^#EXT-X-CUE-IN:(.*)?$/.exec(t),e)return s={type:"tag",tagType:"cue-in"},e[1]?s.data=e[1]:s.data="",void this.trigger("data",s);if(e=/^#EXT-X-SKIP:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"skip"},s.attributes=b(e[1]),s.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(s.attributes["SKIPPED-SEGMENTS"]=parseInt(s.attributes["SKIPPED-SEGMENTS"],10)),s.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(s.attributes["RECENTLY-REMOVED-DATERANGES"]=s.attributes["RECENTLY-REMOVED-DATERANGES"].split(E)),void this.trigger("data",s);if(e=/^#EXT-X-PART:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"part"},s.attributes=b(e[1]),["DURATION"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),["INDEPENDENT","GAP"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=/YES/.test(s.attributes[t]))})),s.attributes.hasOwnProperty("BYTERANGE")&&(s.attributes.byterange=y(s.attributes.BYTERANGE)),void this.trigger("data",s);if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"server-control"},s.attributes=b(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=/YES/.test(s.attributes[t]))})),void this.trigger("data",s);if(e=/^#EXT-X-PART-INF:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"part-inf"},s.attributes=b(e[1]),["PART-TARGET"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),void this.trigger("data",s);if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"preload-hint"},s.attributes=b(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(t){if(s.attributes.hasOwnProperty(t)){s.attributes[t]=parseInt(s.attributes[t],10);const e="BYTERANGE-LENGTH"===t?"length":"offset";s.attributes.byterange=s.attributes.byterange||{},s.attributes.byterange[e]=s.attributes[t],delete s.attributes[t]}})),void this.trigger("data",s);if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(t),e&&e[1])return s={type:"tag",tagType:"rendition-report"},s.attributes=b(e[1]),["LAST-MSN","LAST-PART"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseInt(s.attributes[t],10))})),void this.trigger("data",s);if(e=/^#EXT-X-DATERANGE:(.*)$/.exec(t),e&&e[1]){s={type:"tag",tagType:"daterange"},s.attributes=b(e[1]),["ID","CLASS"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=String(s.attributes[t]))})),["START-DATE","END-DATE"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=new Date(s.attributes[t]))})),["DURATION","PLANNED-DURATION"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),["END-ON-NEXT"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=/YES/i.test(s.attributes[t]))})),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=s.attributes[t].toString(16))}));const t=/^X-([A-Z]+-)+[A-Z]+$/;for(const e in s.attributes){if(!t.test(e))continue;const i=/[0-9A-Fa-f]{6}/g.test(s.attributes[e]),a=/^\\d+(\\.\\d+)?$/.test(s.attributes[e]);s.attributes[e]=i?s.attributes[e].toString(16):a?parseFloat(s.attributes[e]):String(s.attributes[e])}this.trigger("data",s)}else if(e=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(t),e)this.trigger("data",{type:"tag",tagType:"independent-segments"});else{if(e=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(t),e)return s={type:"tag",tagType:"content-steering"},s.attributes=b(e[1]),void this.trigger("data",s);this.trigger("data",{type:"tag",data:t.slice(4)})}}}}else this.trigger("data",{type:"comment",text:t.slice(1)})}))}addParser({expression:t,customType:e,dataParser:s,segment:i}){"function"!=typeof s&&(s=t=>t),this.customParsers.push((a=>{if(t.exec(a))return this.trigger("data",{type:"custom",data:s(a),customType:e,segment:i}),!0}))}addTagMapper({expression:t,map:e}){this.tagMappers.push((s=>t.test(s)?e(s):s))}}const S=function(t){const e={};return Object.keys(t).forEach((function(s){var i;e[(i=s,i.toLowerCase().replace(/-(\\w)/g,(t=>t[1].toUpperCase())))]=t[s]})),e},R=function(t){const{serverControl:e,targetDuration:s,partTargetDuration:i}=t;if(!e)return;const a="#EXT-X-SERVER-CONTROL",r="holdBack",n="partHoldBack",o=s&&3*s,u=i&&2*i;s&&!e.hasOwnProperty(r)&&(e[r]=o,this.trigger("info",{message:`${a} defaulting HOLD-BACK to targetDuration * 3 (${o}).`})),o&&e[r]<o&&(this.trigger("warn",{message:`${a} clamping HOLD-BACK (${e[r]}) to targetDuration * 3 (${o})`}),e[r]=o),i&&!e.hasOwnProperty(n)&&(e[n]=3*i,this.trigger("info",{message:`${a} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${e[n]}).`})),i&&e[n]<u&&(this.trigger("warn",{message:`${a} clamping PART-HOLD-BACK (${e[n]}) to partTargetDuration * 2 (${u}).`}),e[n]=u)};class I extends h{constructor(){super(),this.lineStream=new T,this.parseStream=new A,this.lineStream.pipe(this.parseStream),this.lastProgramDateTime=null;const t=this,e=[];let s,i,a={},r=!1;const n=function(){},o={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}};let u=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],segments:[]};let g=0,l=0;const c={};this.on("end",(()=>{a.uri||!a.parts&&!a.preloadHints||(!a.map&&s&&(a.map=s),!a.key&&i&&(a.key=i),a.timeline||"number"!=typeof u||(a.timeline=u),this.manifest.preloadSegment=a)})),this.parseStream.on("data",(function(h){let d,m;({tag(){({version(){h.version&&(this.manifest.version=h.version)},"allow-cache"(){this.manifest.allowCache=h.allowed,"allowed"in h||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const t={};"length"in h&&(a.byterange=t,t.length=h.length,"offset"in h||(h.offset=g)),"offset"in h&&(a.byterange=t,t.offset=h.offset),g=t.offset+t.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),h.title&&(a.title=h.title),h.duration>0&&(a.duration=h.duration),0===h.duration&&(a.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=e},key(){if(h.attributes)if("NONE"!==h.attributes.METHOD)if(h.attributes.URI){if("com.apple.streamingkeydelivery"===h.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:h.attributes});if("com.microsoft.playready"===h.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.microsoft.playready"]={uri:h.attributes.URI});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===h.attributes.KEYFORMAT){return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(h.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===h.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==h.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):h.attributes.KEYID&&"0x"===h.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:h.attributes.KEYFORMAT,keyId:h.attributes.KEYID.substring(2)},pssh:f(h.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}))}h.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),i={method:h.attributes.METHOD||"AES-128",uri:h.attributes.URI},void 0!==h.attributes.IV&&(i.iv=h.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else i=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence"(){isFinite(h.number)?this.manifest.mediaSequence=h.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+h.number})},"discontinuity-sequence"(){isFinite(h.number)?(this.manifest.discontinuitySequence=h.number,u=h.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+h.number})},"playlist-type"(){/VOD|EVENT/.test(h.playlistType)?this.manifest.playlistType=h.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+h.playlist})},map(){s={},h.uri&&(s.uri=h.uri),h.byterange&&(s.byterange=h.byterange),i&&(s.key=i)},"stream-inf"(){this.manifest.playlists=e,this.manifest.mediaGroups=this.manifest.mediaGroups||o,h.attributes?(a.attributes||(a.attributes={}),p(a.attributes,h.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||o,!(h.attributes&&h.attributes.TYPE&&h.attributes["GROUP-ID"]&&h.attributes.NAME))return void this.trigger("warn",{message:"ignoring incomplete or missing media group"});const t=this.manifest.mediaGroups[h.attributes.TYPE];t[h.attributes["GROUP-ID"]]=t[h.attributes["GROUP-ID"]]||{},d=t[h.attributes["GROUP-ID"]],m={default:/yes/i.test(h.attributes.DEFAULT)},m.default?m.autoselect=!0:m.autoselect=/yes/i.test(h.attributes.AUTOSELECT),h.attributes.LANGUAGE&&(m.language=h.attributes.LANGUAGE),h.attributes.URI&&(m.uri=h.attributes.URI),h.attributes["INSTREAM-ID"]&&(m.instreamId=h.attributes["INSTREAM-ID"]),h.attributes.CHARACTERISTICS&&(m.characteristics=h.attributes.CHARACTERISTICS),h.attributes.FORCED&&(m.forced=/yes/i.test(h.attributes.FORCED)),d[h.attributes.NAME]=m},discontinuity(){u+=1,a.discontinuity=!0,this.manifest.discontinuityStarts.push(e.length)},"program-date-time"(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=h.dateTimeString,this.manifest.dateTimeObject=h.dateTimeObject),a.dateTimeString=h.dateTimeString,a.dateTimeObject=h.dateTimeObject;const{lastProgramDateTime:t}=this;this.lastProgramDateTime=new Date(h.dateTimeString).getTime(),null===t&&this.manifest.segments.reduceRight(((t,e)=>(e.programDateTime=t-1e3*e.duration,e.programDateTime)),this.lastProgramDateTime)},targetduration(){!isFinite(h.duration)||h.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+h.duration}):(this.manifest.targetDuration=h.duration,R.call(this,this.manifest))},start(){h.attributes&&!isNaN(h.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:h.attributes["TIME-OFFSET"],precise:h.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out"(){a.cueOut=h.data},"cue-out-cont"(){a.cueOutCont=h.data},"cue-in"(){a.cueIn=h.data},skip(){this.manifest.skip=S(h.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",h.attributes,["SKIPPED-SEGMENTS"])},part(){r=!0;const t=this.manifest.segments.length,e=S(h.attributes);a.parts=a.parts||[],a.parts.push(e),e.byterange&&(e.byterange.hasOwnProperty("offset")||(e.byterange.offset=l),l=e.byterange.offset+e.byterange.length);const s=a.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${s} for segment #${t}`,h.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach(((t,e)=>{t.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${e} lacks required attribute(s): LAST-PART`})}))},"server-control"(){const t=this.manifest.serverControl=S(h.attributes);t.hasOwnProperty("canBlockReload")||(t.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),R.call(this,this.manifest),t.canSkipDateranges&&!t.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const t=this.manifest.segments.length,e=S(h.attributes),s=e.type&&"PART"===e.type;a.preloadHints=a.preloadHints||[],a.preloadHints.push(e),e.byterange&&(e.byterange.hasOwnProperty("offset")||(e.byterange.offset=s?l:0,s&&(l=e.byterange.offset+e.byterange.length)));const i=a.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${i} for segment #${t}`,h.attributes,["TYPE","URI"]),e.type)for(let r=0;r<a.preloadHints.length-1;r++){const s=a.preloadHints[r];s.type&&(s.type===e.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${i} for segment #${t} has the same TYPE ${e.type} as preload hint #${r}`}))}},"rendition-report"(){const t=S(h.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(t);const e=this.manifest.renditionReports.length-1,s=["LAST-MSN","URI"];r&&s.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${e}`,h.attributes,s)},"part-inf"(){this.manifest.partInf=S(h.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",h.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),R.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(S(h.attributes));const t=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${t}`,h.attributes,["ID","START-DATE"]);const e=this.manifest.dateRanges[t];e.endDate&&e.startDate&&new Date(e.endDate)<new Date(e.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),e.duration&&e.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),e.plannedDuration&&e.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});const s=!!e.endOnNext;if(s&&!e.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),s&&(e.duration||e.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),e.duration&&e.endDate){const s=e.startDate.getTime()+1e3*e.duration;this.manifest.dateRanges[t].endDate=new Date(s)}if(c[e.id]){for(const s in c[e.id])if(e[s]&&JSON.stringify(c[e.id][s])!==JSON.stringify(e[s])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}const t=this.manifest.dateRanges.findIndex((t=>t.id===e.id));this.manifest.dateRanges[t]=p(this.manifest.dateRanges[t],e),c[e.id]=p(c[e.id],e),this.manifest.dateRanges.pop()}else c[e.id]=e},"independent-segments"(){this.manifest.independentSegments=!0},"content-steering"(){this.manifest.contentSteering=S(h.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",h.attributes,["SERVER-URI"])}}[h.tagType]||n).call(t)},uri(){a.uri=h.uri,e.push(a),this.manifest.targetDuration&&!("duration"in a)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),a.duration=this.manifest.targetDuration),i&&(a.key=i),a.timeline=u,s&&(a.map=s),l=0,null!==this.lastProgramDateTime&&(a.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=1e3*a.duration),a={}},comment(){},custom(){h.segment?(a.custom=a.custom||{},a.custom[h.customType]=h.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[h.customType]=h.data)}})[h.type].call(t)}))}warnOnMissingAttributes_(t,e,s){const i=[];s.forEach((function(t){e.hasOwnProperty(t)||i.push(t)})),i.length&&this.trigger("warn",{message:`${t} lacks required attribute(s): ${i.join(", ")}`})}push(t){this.lineStream.push(t)}end(){this.lineStream.push("\\n"),this.manifest.dateRanges.length&&null===this.lastProgramDateTime&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(t){this.parseStream.addParser(t)}addTagMapper(t){this.parseStream.addTagMapper(t)}}class O{constructor(){e(this,"integrityToken",""),e(this,"streamList",[]),e(this,"actualChannel",""),e(this,"playingAds",!1),e(this,"setting"),e(this,"quality",""),e(this,"freeStream",!1),e(this,"getQuality",(()=>self.postMessage({type:"getQuality"}))),e(this,"getSettings",(()=>self.postMessage({type:"getSettings"}))),e(this,"pause",(()=>self.postMessage({type:"pause"}))),e(this,"play",(()=>self.postMessage({type:"play"}))),e(this,"setSettings",(t=>{this.setting=t,logPrint("Settings loaded")})),e(this,"setIntegrityToken",(t=>this.integrityToken=t)),e(this,"pauseAndPlay",(async()=>{this.pause(),await new Promise((t=>setTimeout(t,1500))),this.play()})),e(this,"onStartAds",(()=>{console.log("ads started"),this.pauseAndPlay()})),e(this,"onEndAds",(()=>{console.log("ads ended"),this.pauseAndPlay()})),e(this,"isAds",((t,e=!1)=>{const s=this.hasAds(t);return e?(0==this.playingAds&&this.playingAds!=s&&this.onStartAds(),1==this.playingAds&&this.playingAds!=s&&this.onEndAds(),this.playingAds=s,this.playingAds):s})),e(this,"hasAds",(t=>(null==t?void 0:t.toString().includes("stitched"))||(null==t?void 0:t.toString().includes("Amazon"))||(null==t?void 0:t.toString().includes("DCM,")))),e(this,"currentStream",((t=this.actualChannel)=>{var e;return null==(e=this.streamList)?void 0:e.find((e=>e.channelName===t))}))}freeStreamChanged(t){this.freeStream!=t&&this.pauseAndPlay(),this.freeStream=t}isWhitelist(){var t,e;return(null==(e=null==(t=this.setting)?void 0:t.whitelist)?void 0:e.includes(this.actualChannel))||!1}async onFetch(t){if(this.isWhitelist())return t;if(!this.isAds(t,!0))return this.freeStream=!1,this.mergeM3u8Contents([t]);const e=[],s=await this.fetchm3u8ByStreamType(a.FRONTPAGE);if(s.data||this.currentStream().createStreamAccess(a.FRONTPAGE,this.integrityToken),s.dump&&e.push(...s.dump),s.data)return s.data;const i=await this.fetchm3u8ByStreamType(a.PICTURE);return i.data||this.currentStream().createStreamAccess(a.PICTURE,this.integrityToken),i.dump&&e.push(...i.dump),i.data?i.data:(this.printViewAds([t,...e]),0!=e.length?this.mergeM3u8Contents([JSON.parse(JSON.stringify(t)),...e]):JSON.parse(JSON.stringify(t)))}printViewAds(t){const e=t.map((t=>{const e=new I;e.push(t),e.end();const s=e.manifest;return s.segments&&s.segments.forEach((e=>{const s=new RegExp(`#EXTINF:([0-9.]*)?,?(.*)(?:\\n|\\r\\n)${e.uri}`),i=t.match(s);i&&(e.title=i[2]?i[2].trim():"")})),s}));let s=[];for(const i of e)i.segments&&i.segments.forEach((t=>{s.push(""+(this.hasAds(t.title)?"X":"V"))}));console.log(s.join("-"))}generateM3u8(t){let e="#EXTM3U\\n";return t.targetDuration&&(e+=`#EXT-X-TARGETDURATION:${t.targetDuration}\\n`),t.mediaSequence&&(e+=`#EXT-X-MEDIA-SEQUENCE:${t.mediaSequence}\\n`),t.segments&&t.segments.forEach((t=>{t.duration&&(e+=`#EXTINF:${t.duration}`,e+="\\n"),e+=`${t.uri}\\n`})),e}mergeM3u8Contents(t){var e,s;const i=t.map((t=>{const e=new I;e.push(t),e.end();const s=e.manifest;return s.segments&&s.segments.forEach((e=>{const s=new RegExp(`#EXTINF:([0-9.]*)?,?(.*)(?:\\n|\\r\\n)${e.uri}`),i=t.match(s);i&&(e.title=i[2]?i[2].trim():"")})),s})),a=i[0],r=i.slice(1);console.log("Segmentos encontrados no manifesto principal:",null==(e=null==a?void 0:a.segments)?void 0:e.length),console.log("Manifestos de suporte encontrados:",r.length);let n=0;if(!(null==(s=a.segments)?void 0:s.length))return this.generateM3u8(a);for(let o=0;o<a.segments.length;o++){const t=a.segments[o];let e=!1;this.hasAds(t.title)&&(r.forEach((s=>{var i,r;const n=null==(i=null==s?void 0:s.segments)?void 0:i.find((e=>{if(this.hasAds(e.title))return!1;const s=new Date(t.dateTimeString),i=new Date(e.dateTimeString);return s.setMilliseconds(0),i.setMilliseconds(0),s.getTime()===i.getTime()}));n&&(null==(r=a.segments)?void 0:r[o])&&(a.segments[o]=n,e=!0)})),e&&n++)}console.log("Segmento com ads removidos:",0),console.log("Segmento com ads substituídos:",n);return this.generateM3u8(a)}async fetchm3u8ByStreamType(t){let e=[],s="",i=this.currentStream().getStreamByStreamType(t);for(const a of i){const i=a.findByQuality(this.quality)||a.bestQuality(),r=await(await self.request(null==i?void 0:i.url)).text();if(e.push(r),!this.isAds(r)){s=r,logPrint("Stream Type: "+t+" - Free Stream");break}logPrint("Stream Type: "+t+" - Ads found"),this.currentStream().removeServer(a)}return{data:s,dump:e}}setChannel(t){logPrint("Loading channel",t),this.actualChannel=t;let e=this.streamList.find((e=>e.channelName===t));e||(e=new c(t),this.streamList.push(e))}}self.request=self.fetch,self.fetch=async(t,e)=>{if("string"==typeof t)for(var s=0,i=routerList.length;s<i;s++)if(t.includes(routerList[s].match)&&!t.includes(routerList[s].ignore))return self.appController[routerList[s].propertyKey](t,e);return self.request.apply(void 0,[t,e])},self.logPrint=t=>console.log("[Purple]: ",t),self.appController=new u(new O),self.logPrint("Script running");\n//# sourceMappingURL=app.worker.js.map\n';(function(){let e;window.Worker=class extends Worker{constructor(t,a){console.log("new worker intance "+t),t.toString()==""&&super(t,a),console.log("[Purple]: init "+t.toString());const s=new XMLHttpRequest;s.open("GET",t.toString(),!1),s.send();const i=s.responseText,r=`${o}
      ${i}`,n=URL.createObjectURL(new Blob([r],{type:"text/javascript"}));super(n),e=this,e.declareEventWorker(),e.declareEventWindow(),e.integrity()}async integrity(){self.request=fetch,self.fetch=async(t,a)=>{const s=await self.request(t,a),i=await s.text();return t=="https://gql.twitch.tv/integrity"&&e.postMessage({funcName:"setIntegrity",value:i}),new Response(i,s)}}declareEventWorker(){this.addEventListener("message",t=>{var a,s,i,r,n;switch((a=t==null?void 0:t.data)==null?void 0:a.type){case"getSettings":{window.postMessage({type:"getSettings",value:null});break}case"PlayerQualityChanged":{e.postMessage({funcName:"setQuality",value:t.data.arg.name});break}case"pause":{e.postMessage({funcName:"pause",args:void 0,id:1});break}case"play":{e.postMessage({funcName:"play",args:void 0,id:1});break}}switch((i=(s=t==null?void 0:t.data)==null?void 0:s.arg)==null?void 0:i.key){case"quality":{if(!t.data.arg.value.name)break;console.log("Changed quality by player: "+t.data.arg.value.name),e.postMessage({funcName:"setQuality",value:t.data.arg.value.name});break}case"state":e.postMessage({funcName:t.data.arg.value})}switch((n=(r=t==null?void 0:t.data)==null?void 0:r.arg)==null?void 0:n.name){}})}declareEventWindow(){window.addEventListener("message",t=>{switch(t.data.type){case"setSettings":e.postMessage({funcName:"setSettings",value:t.data.value})}})}}})();
